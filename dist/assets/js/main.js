function toggleModal(){fab.classList.toggle("modalOpen"),newJourneySection.classList.toggle("modalOpen")}function DisplayMessage(e,t){this.displayMessageEl=document.getElementsByClassName("display-message")[0],this.messageEl=document.getElementsByClassName("dm__message")[0],this.actionBTN=document.getElementsByClassName("dm__action")[0],this.dismissBTN=document.getElementsByClassName("dm__dismiss")[0],this._init(e,t)}function Loader(e){this._target=e,this._loader=document.createElement("div"),this._loader.classList.add("spinner"),this._loader.innerHTML='<div class="double-bounce1"></div>\t\t\t\t\t\t\t  <div class="double-bounce2"></div>',this._init()}function IndexController(){this._dbPromise=this._setupDB(),this._registerServiceWorker(),this.showDefaultJourney()}function Journey(e,t,o){this._savedJourney=!1,this._hideLoader=o,t?this._savedJourney=t:e&&(this._fromCoordinates=e.fromCoordinates,this._toCoordinates=e.toCoordinates,this._fromName=e.fromName?"&fromName="+e.fromName:"",this._toName=e.toName?"&toName="+e.toName:"",this._fetchUrl="https://api.tfl.gov.uk/Journey/JourneyResults/"+this._fromCoordinates+"/to/"+this._toCoordinates+"?nationalSearch=True&timeIs=Departing&journeyPreference=LeastTime&mode=tube&walkingSpeed=Average&cyclePreference=None&alternativeCycle=False&alternativeWalking=False&applyHtmlMarkup=False&useMultiModalCall=False&walkingOptimization=False"+this._fromName+this._toName+"&app_id="+app_id+"&app_key="+app_key),this._init()}var fab=document.getElementsByClassName("fab")[0],newJourneySection=document.getElementsByClassName("new-journey")[0];fab.addEventListener("click",function(){toggleModal()}),DisplayMessage.prototype._toggle=function(){this.displayMessageEl.classList.toggle("open")},DisplayMessage.prototype._reset=function(){this.displayMessageEl.classList.remove("success","danger"),this.messageEl.innerHTML="",this.actionBTN.style.display=""},DisplayMessage.prototype.setupAction=function(e,t){!e|!t&&(this.actionBTN.style.display="none"),this.actionBTN.innerHTML=e,this.actionBTN.addEventListener("click",t)},DisplayMessage.prototype._init=function(e,t){this._reset(),this.displayMessageEl.classList.add(e),this.messageEl.innerHTML=t,this._toggle();var o=this;this.dismissBTN.addEventListener("click",function(){o._toggle()})},Loader.prototype._init=function(){this._target.innerHTML="",this._target.appendChild(this._loader)},Loader.prototype.remove=function(){this._target.removeChild(this._loader)},IndexController.prototype._setupDB=function(){return navigator.serviceWorker?dbPromise=idb.open("tplanr",1,function(e){e.createObjectStore("journeys",{keyPath:"departure_time"})}):Promise.resolve()},IndexController.prototype._registerServiceWorker=function(){"serviceWorker"in navigator&&(navigator.serviceWorker.register("./service-worker.js",{scope:"./"}).then(function(e){if(e.waiting)return console.log("reg waiting"),void new DisplayMessage("success","There's a new verion of TubePlanr available! Click refresh to update").setupAction("Refresh",function(){e.waiting.postMessage({action:"skipWaiting"})})})["catch"](function(e){console.log("Service Worker Failed to Register",e)}),navigator.serviceWorker.addEventListener("controllerchange",function(){window.location.reload()}))},IndexController.prototype._handleEmptyState=function(){toggleModal()},IndexController.prototype.showDefaultJourney=function(){var e=this;this._dbPromise.then(function(e){var t=e.transaction("journeys","readwrite"),o=t.objectStore("journeys");return o.getAll()}).then(function(t){return 0==t.length?(e._handleEmptyState(),Promise.reject()):(new Journey(null,t[0]),Promise.resolve(t[0]))}).then(function(e){var t=e.journeys[0].legs[0].departurePoint,o=e.journeys[0].legs[e.journeys[0].legs.length-1].arrivalPoint;({fromCoordinates:t.lat+","+t.lon,toCoordinates:o.lat+","+o.lon,fromName:e.departure_location,toName:e.arrival_location})})};var Controller=new IndexController,app_id="1e55ad45",app_key="40c230d6c65288e70be34a738dcc6b91";Journey.prototype._setupData=function(e){for(var t={departure_location:e.journeys[0].legs[0].departurePoint.commonName,arrival_location:e.journeys[0].legs[e.journeys[0].legs.length-1].arrivalPoint.commonName,departure_time:e.journeys[0].startDateTime,journeys:e.journeys},o=0;o<e.journeys.length;o++){var n=e.journeys[o];t.journeys[o].points=[],t.journeys[o].departure_location,t.journeys[o].arrival_location;for(var r=0;r<n.legs.length;r++){var s=n.legs[r];0!=r&&t.journeys[o].points.push(!0),0==r&&(t.journeys[o].departure_location=s.departurePoint.commonName),r==n.legs.length-1&&(t.journeys[o].arrival_location=s.arrivalPoint.commonName)}}return t},Journey.prototype._fetchData=function(){return fetch(this._fetchUrl).then(function(e){return e.json()})["catch"](function(e){return console.log("fetch caught in _fetchdata",e),Promise.reject(e)})},Journey.prototype._clearDB=function(){return Controller._dbPromise.then(function(e){var t=e.transaction("journeys","readwrite"),o=t.objectStore("journeys");return o.openCursor()}).then(function e(t){if(t)return t["delete"](),t["continue"]().then(e)}).then(function(){return Promise.resolve()})},Journey.prototype._addToDB=function(e,t){return t._clearDB().then(function(){return Controller._dbPromise.then(function(t){var o=t.transaction("journeys","readwrite"),n=o.objectStore("journeys");return n.put(e),o.complete}).then(function(){console.log("Added to db")})["catch"](function(e){console.log("Error adding to db",e)})})},Journey.prototype._displayJourney=function(e){var t=MyApp.templates.journeys(e);return document.getElementById("journeys").innerHTML=t,Promise.resolve(e)},Journey.prototype._init=function(){var e=this;this._savedJourney?e._displayJourney(this._savedJourney):(this._hideLoader||new Loader(document.getElementById("journeys")),this._fetchData().then(e._setupData).then(e._displayJourney).then(function(t){return e._addToDB(t,e)})["catch"](function(e){console.log("caught error from Journey.prototype._init",e),new DisplayMessage("danger","Oops! Looks like we were unable to get your new route. Here is your last searched journey instead").setupAction(!1),Controller.showDefaultJourney()}))},fetch("/assets/data/stations.json").then(function(e){return e.json()}).then(function(e){var t={stations:e},o=MyApp.templates.stations(t);return document.getElementById("location_from").innerHTML=o,document.getElementById("location_to").innerHTML=o,Promise.resolve()}).then(function(){var e={sortField:{field:"text",direction:"asc"}};$("#location_from").selectize(e),$("#location_to").selectize(e)});var newJourneyForm=document.getElementById("new-journey-form");newJourneyForm.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("location_from"),o=document.getElementById("location_to"),n=t.value,r=o.value,s=t.options[t.selectedIndex].text,i=o.options[o.selectedIndex].text;if(!n|!r)return void new DisplayMessage("danger","You need to select both a departure and arrival station").setupAction(!1);var a={fromCoordinates:n,toCoordinates:r,fromName:s,toName:i};new Journey(a),toggleModal()});